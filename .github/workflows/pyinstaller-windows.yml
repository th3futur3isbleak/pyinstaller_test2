name: PyInstaller

on:
    push:
        branches:
            - main
    # Allows you to run this workflow manually from the Actions tab
    workflow_dispatch:
# Set these environment variables for your project
env:
    PYINST_EXE_NAME: show_version
    SOURCE_PYTHON_FILE_PATH: show_version.py
    _PYTHON_VERSION: 3.8
    PACKAGE_NAME: pyinstaller_test2

jobs:
    build:
        runs-on: windows-latest
        steps:
            -   uses: actions/checkout@v1
            -   name: Set up Python ${{env._PYTHON_VERSION}}
                # Checkout the repository
                uses: actions/setup-python@v1
                with:
                    python-version: ${{env._PYTHON_VERSION}}
            -   name: Install dependencies
                # Install python dependencies
                # If the requirements.txt is in a different directory,
                # or if python setup.py is used, change accordingly
                run: |
                    python -m pip install --upgrade pip
                    pip install setuptools wheel twine build
                    pip install .[testing,documentation]
            -   name: Pytest
                env:
                    PACKAGE_NAME: ${{env.PACKAGE_NAME}}
                run: |
                    # pytest tests --junitxml=test_results/junit/test-results.xml --json-report --json-report-file=test_results/pytest-reports/unit_tests.json --html=test_results/pytest-reports/unit_tests_report.html --self-contained-html --cov=pyinstaller_test tests/ --cov-report html:test_results/coverage/cov_html --cov-report xml:test_results/coverage/cov.xml --cov-report annotate:test_results/coverage/cov_annotate --cov=pyinstaller_test tests/
                    .github/workflows/run_pytest.bat
            -   name: Pylint
                run: |
                    pylint -r y --output test_results/pylint.txt --exit-zero ${{env.PACKAGE_NAME}}/
            -   name: Flake8
                run: |
                    flake8 --exit-zero ${{env.PACKAGE_NAME}}/ --tee --output test_results/flake8.txt
            -   name: Radon
                run: |
                    radon cc ${{env.PACKAGE_NAME}}/ > test_results/radon_cc.txt
                    # radon raw ${{env.PACKAGE_NAME}}/ > test_results/radon_raw.txt
                    # radon mi ${{env.PACKAGE_NAME}}/ > test_results/radon_mi.txt
                    # radon hal ${{env.PACKAGE_NAME}}/ > test_results/radon_hal.txt
            -   name: Build HTML documentation
                run: |
                    make docs
            -   name: List documentation files
                run: |
                    cmd /r dir /s docs\_build\html\
            -   name: Upload html documentation artifact
                uses: actions/upload-artifact@v2
                with:
                    name: htmldoc
                    path: docs\_build\html\
            -   name: Upload Pylint, Flake8, Radon testing artifact
                uses: actions/upload-artifact@v2
                with:
                    name: test_results
                    path: test_results\

            -   name: Dump GitHub context
                env:
                    GITHUB_CONTEXT: ${{ toJson(github) }}
                run: |
                    echo "$GITHUB_CONTEXT"
                    echo ${{github.ref}}
                    echo ${{github.event}}
